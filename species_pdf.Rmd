---
title: "&nbsp;"
always_allow_html: true
output:
  pdf_document: 
    latex_engine: xelatex
    keep_tex: true
classoption: x11names
header-includes:
  \usepackage{fontspec}
  \usepackage{titling}
  \pretitle{\begin{center}
  \LARGE
  \vspace{-3.3cm}
  \includegraphics[width=\linewidth]{images/Base_info/logo.png}\\}
  \posttitle{\end{center}}
  \usepackage{framed}
  \usepackage{float}
  \usepackage{fancyhdr}
  \usepackage{ragged2e}
  \usepackage{caption}
  \usepackage{colortbl}
  \usepackage[export]{adjustbox}
  \usepackage{wrapfig}
  \captionsetup[figure]{labelformat=empty}
  \arrayrulecolor{white}
  \pagestyle{fancy}
  \fancyhead[L,C]{}
  \fancypagestyle{plain}{\pagestyle{fancy}}
  \PassOptionsToPackage{dvipsnames,svgnames*,x11names*}{xcolor}
  \definecolor{ceil}{rgb}{0.57, 0.63, 0.81}
params:
  species:  "Pudu puda"
editor_options: 
  chunk_output_type: console
---

\renewenvironment{framed}[1][\hsize]
  {\MakeFramed{\hsize#1\advance\hsize-\width \FrameRestore}}%
  {\endMakeFramed}
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, eval=TRUE)
library(rvest)
library(tidyverse)
library(kableExtra)
library(huxtable)
options(huxtable.latex_use_fontspec = TRUE)
source('R/funcs.R', local = knitr::knit_global())

db <- read_csv('data/especies_nativas.csv')
dois <- read_csv('data/species_doi.csv')

db.sp <- db %>% filter(title == params$species) %>% 
  mutate(sp_distribuida_en_numero_de_loc = ifelse(is.na(sp_distribuida_en_numero_de_loc) & 
                                                    !is.na(sp_numero_de_localidades),
                                                  sp_numero_de_localidades,
                                                  sp_distribuida_en_numero_de_loc)) %>% 
  mutate(sp_numero_de_localidades = ifelse(is.na(sp_numero_de_localidades) & 
                                                    !is.na(sp_distribuida_en_numero_de_loc),
                                           sp_distribuida_en_numero_de_loc,
                                           sp_numero_de_localidades))

spDoi <- dois$DOI[ match(db.sp$title, dois$Especie) ] %>% str_trim()
cat.logo <- db.sp$sp_cat_nac_conserv_2019 %>% 
  str_split(' ', simplify = TRUE) %>% .[1] %>% tolower()

cat.logo <- paste0('images/', cat.logo, '.png')

photo <- list.files('photos/', '.jpg$', full.names = T, recursive = T)
filePhoto <- CMA_get_photo_index(db.sp$title)
credistPhoto <- CMA_get_photo_credits(photo[filePhoto])
```

\setmainfont{Arial}
\setsansfont{Arial}
\setmonofont{Arial}

\newcommand\invisiblesection[1]{%
  \refstepcounter{section}%
  \addcontentsline{toc}{section}{\protect\numberline{\thesection}#1}%
  \sectionmark{#1}}
  
\fancyhead[R]{\textbf{`r spDoi`}}

\invisiblesection{GENERALIDADES}

\vspace{-3cm}


\begin{minipage}{0.75\textwidth}
\vspace{0.15cm}
{\fontsize{18}{22}\selectfont\textit{`r db.sp$title`}}

\vspace{0.3cm}
\begin{flushleft}
{\fontsize{30}{36}\selectfont\textbf{`r db.sp$sp_nombre_comun`}}
\end{flushleft}
\end{minipage}
\hspace{0.05\textwidth}
\begin{minipage}{0.2\textwidth}
\includegraphics[width=\textwidth]{`r cat.logo`}\\
\end{minipage}

\normalsize

```{r photo, fig.pos='H',  fig.align='center', out.width='162 mm',fig.cap= paste0("Foto: ", credistPhoto[1]), eval=TRUE}
if(length(filePhoto) > 0){
  knitr::include_graphics(photo[filePhoto[1]]) 
} else { 
  knitr::include_graphics('photos/Insert-Image-Here.png') 
}
```

\vspace{-1cm}
***

\justifying

**Cita sugerida:** `r db.sp$sp_autores_de_ficha`. (2019). *`r db.sp$title`*. En: SAyDS--SAREM (eds.) Categorización 2019 de los mamíferos de Argentina según su riesgo de extinción. Lista Roja de los mamíferos de Argentina. `r spDoi`

***

\newpage

\vspace{-0.4cm}

```{r title.addition.photos, results='asis', eval=TRUE, out.width='162 mm'}
if(length(filePhoto)>1) {
  CMA_print_titles("OTRAS FOTOGRAFÍAS") %>% cat
  
  cat('\\vspace{-0.7cm}\n\n')
  
  CMA_print_photo(photo[ filePhoto[-1] ], credits = credistPhoto[-1]) %>% cat
  # for(i in 2:length(filePhoto)) {
  #   CMA_print_photo(x = photo[ filePhoto[i] ],
  #                   credits = credistPhoto[i]) %>% cat
  #   # cat('\n\n\\vspace{-0.3cm}')
  # }
}
```

\newpage

\vspace{-0.4cm}

```{r map.sp,  results='asis', eval=TRUE}
CMA_print_titles("ÁREA DE DISTRIBUCIÓN ACTUAL")%>% cat()
```

\vspace{-0.4cm}

```{r map, fig.pos="H",  out.width="100%", eval=TRUE}
knitr::include_graphics(
  # 'maps/Cetartiodactyla/Balaenoptera_acutorostrata.png')
  paste0('maps/', db.sp$sp_taxonomia_orden, '/',
         gsub(' ', '_', db.sp$title), '.png')
  )
```

```{r title.cons,  results='asis'}
CMA_print_titles("CATEGORÍAS DE CONSERVACIÓN")%>% cat()
```

\vspace{-0.4cm}

```{r cont.cons.b, results='asis'}
out <- tibble(
  "Categoría Nacional de Conservación 2019" = db.sp$sp_cat_nac_conserv_2019) 

if(!is.na(db.sp$sp_cat_nac_conserv_2019_criterio)) {
  out <- out %>% add_column("Criterios y subcriterios" = db.sp$sp_cat_nac_conserv_2019_criterio)  
} else {
  out <- out %>% add_column(" " = "")
}
out %>% 
  kbl(booktabs = T, format = 'latex', escape = F) %>% 
  kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
  row_spec(0, bold=T) %>% cat

```

```{r, results='asis'}
CMA_print_in_line(db.sp$sp_cat_nac_conserv_2019_justific %>% 
                    str_replace_all('\n', '\n\n'), 
                  'Justificación de la categorización', '\n\n')
```

```{r tabla-subpoblaciones,  results='asis'}
if(!is.na(db.sp$group_sp_eval_subpob)) {
  cat("**Evaluación de subpoblaciones locales**\n\n")

tbsPob <- CMA_subpop_cons(db.sp)

for(x in seq_along(tbsPob)){
  cat(paste0(tbsPob[[x]][[1]], collapse = '\\vspace{0.3cm}'))
  if(!is.na(tbsPob[[x]][[2]])) {
    cat(paste0(tbsPob[[x]][[2]], collapse = '\\vspace{0.3cm}'))
  } else{ 
    cat('\\vspace{0.3cm}')
    }
  if(x != length(tbsPob)) cat('\\vspace{0.5cm}')
  }
}

cat('\n\n')
CMA_print_in_line(db.sp$sp_cat_sayds_conserv_2004, 'Categoría Res. SAyDS 1030/04', '\n\n')
```

```{r cat.nac.prev, echo=FALSE, include=T, results='asis'}
cat('**Categorías nacionales de conservación previas (SAREM)**\n\n')

ph <- c("sp_cat_nac_conserv_XXX", "sp_cat_nac_conserv_XXX_criterio")
for(c in c("2012", "2000", "1997")){
  if(!is.na(db.sp[[paste0('sp_cat_nac_conserv_', c)]][1])){
    db.sp %>% 
      mutate(a = c) %>% 
      select(a, str_replace(ph, 'XXX', c)) %>%  
      drop_col_na() %>% 
      kbl(booktabs = T, format = 'latex', escape = F, 
          col.names = NULL) %>% 
      kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
      column_spec(1, bold=T) %>% cat()
    cat('\n\n')
  }
}
  
  data.frame('Homologación categoría 1997', 
        db.sp$sp_cat_nac_conserv_1997_hom) %>% 
    kbl(booktabs = T, format = 'latex', escape = F, col.names = NULL) %>% 
    kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
    column_spec(1, bold=T) %>% cat()
```

```{r cat.cons.pais.vec,  results='asis'}
if(!is.na(db.sp$group_sp_eval_paises_vecinos)){
  cat('**Categorías de conservación actuales en países vecinos**\n\n')
  out <- CMA_neighbor_countries(db.sp) 
  for(i in out){cat(i)}
}
```

```{r cat.iucn,  results='asis'}
if(!is.na(db.sp$sp_eval_global_iucn_anio)){
  cat('**Evaluación global UICN**')
tibble(
  "Año de evaluación" = as.character(db.sp$sp_eval_global_iucn_anio), 
  "Categoría" = db.sp$sp_eval_global_iucn_categoria, 
  "Criterios y subcriterios" = db.sp$sp_eval_global_iucn_criterios) %>% drop_col_na() %>% 
   kbl(booktabs = T, format = 'latex') %>% 
               row_spec(0,bold=TRUE, 
                        extra_latex_after = "\\arrayrulecolor{white}") %>% 
               kable_styling(latex_options = c('striped', "HOLD_position"),
                             position = "center", full_width = T) %>% cat()
}
```

\arrayrulecolor{white}

```{r title.taxo, results='asis'}
CMA_print_titles("TAXONOMÍA Y NOMENCLATURA") %>% cat()
```

\vspace{-0.4cm}

```{r taxo.cont,  results='asis'}
conTaxo <- CMA_parse_taxonomy(db.sp)
for(i in conTaxo){
  cat(i, collapse = '\\vspace{0.3cm}')
}
```

```{r taxo.comment,  results='asis'}
if(!is.na(db.sp$sp_taxonomia_comentarios)){
  cat('**Comentarios taxonómicos**\n\n')
  
  cat(CMA_italize_binomial(db.sp$sp_taxonomia_comentarios, db.sp$title) %>% 
        str_replace_all('\n', '\n\n'))
}
```

\arrayrulecolor{white}

```{r title.eval, results='asis', eval=TRUE}
CMA_print_titles("INFORMACIÓN RELEVANTE PARA LA EVALUACIÓN") %>% cat()

```

\vspace{-0.4cm}

```{r cont.eval,  results='asis', eval=TRUE}
CMA_parse_eval(db.sp)
```

```{r title.rango, results='asis'}
CMA_print_titles("RANGO GEOGRÁFICO, OCURRENCIA Y ABUNDANCIA") %>% cat()
```

\vspace{-0.4cm}

```{r cont.rango, echo=F, include=TRUE, results='asis'}
cat(paste0('**Presencia en el territorio nacional:** ', 
    db.sp$sp_residente_migrante_o_errante, '\n\n'))

cat('**Comentarios sobre la distribución actual e histórica**\n\n')
cat(db.sp$sp_distribucion_historica_coment)
cat('\n\n')
n <- db.sp$sp_presencia_confirmada_por_pcia %>% str_split(',', simplify = T) %>% str_trim()
if(!all(is.na(n))){
tibble(
  c("Presencia confirmada por provincia:", 
    rep("", length(n)-1)), '', n) %>% CMA_kable_output(cat = 'other') %>% cat
cat('\n\n')
}

n <- db.sp$sp_confirmada_por_ecorreg_de_arg %>% str_split(',', simplify = T) %>% str_trim()
if(!all(is.na(n))){
tibble(
  c("Presencia en ecorregiones de Argentina:", 
    rep("", length(n)-1)), '', n) %>% CMA_kable_output(cat = 'other') %>% cat
cat('\n\n')
}

n <- db.sp$sp_confirmada_por_ecorreg_terres %>% str_split(',', simplify = T) %>% str_trim()
if(!all(is.na(n))){
tibble(
  c("Presencia en ecorregiones globales terrestres:", 
    rep("", length(n)-1)), '', n) %>% CMA_kable_output(cat = 'other') %>% cat
cat('\n\n')
}

tibble(
  "Patrón de distribución"= db.sp$sp_patron_de_distribucion,
  "Cantidad de localidades" = db.sp$sp_numero_de_localidades, 
  "Rango altitudinal"= db.sp$sp_rango_altitudinal, 
  'Rango de profundidad'= db.sp$sp_rango_de_profundidad) %>%
  drop_col_na() %>% 
  kbl(booktabs = T, format = 'latex',linesep = "", escape = F) %>% 
      kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
  row_spec(0, bold=T) %>% cat


cat('\n\n')
tibble(
  x= c('Endemismo'), 
  y = c(db.sp$sp_distribucion_endemismo)
) %>% 
  kbl(booktabs = T, format = 'latex',col.names = NULL, escape = F) %>% 
  kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
  column_spec(1, bold=T) %>% cat

cat('\n\n')
tibble(
  x= c('Abundancia relativa estimada en su área de ocupación'), 
  y = c(db.sp$sp_abundancia)
) %>% 
  kbl(booktabs = T, format = 'latex',col.names = NULL, escape = F) %>% 
  kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
  column_spec(1, bold=T) %>% cat

cat('\n\n**Comentarios sobre la abundancia, densidad o probabilidad de ocupación de la especie**\n\n')

cat(db.sp$sp_abundancia_comentarios %>% 
      str_replace_all('\n', '\n\n') %>% 
      CMA_italize_binomial(., db.sp$title))

cat(paste0('\n\n**¿Existen actualmente programas de monitoreo?:** ',
           db.sp$sp_programas_de_monitoreo,
           '\n\n'))
if(!is.na(db.sp$sp_programas_de_monitoreo_coment)) db.sp$sp_programas_de_monitoreo_coment%>% str_replace_all('\n', '\n\n') %>% cat

```

\arrayrulecolor{white}


```{r cont.morfo,  results='asis'}
out <- tibble(
  Peso = db.sp$sp_peso, 
  "Peso de la hembra" = db.sp$sp_peso_de_la_hembra, 
  "Peso del macho" = db.sp$sp_peso_del_macho, 
  "Comentarios" = db.sp$sp_peso_comentarios
)
allNA <- all(is.na(out[1,]))
if(!allNA){
  CMA_print_titles("DATOS MORFOMÉTRICOS") %>% cat()
  
  cat('\\vspace{-0.4cm}')
  
out <- out[ , which(!is.na(out[1,])) ]

out %>%  
  kbl(booktabs = T, format = 'latex',linesep = "", escape = F) %>% 
  kable_styling(latex_options = c('striped', "HOLD_position"),
                    position = "center", full_width = T) %>%
  row_spec(0, bold=T) %>% cat
}
```

\arrayrulecolor{white}

```{r title.eto, results='asis'}
CMA_print_titles("RASGOS ETO-ECOLÓGICOS") %>% cat()
```

\vspace{-0.4cm}

```{r habs.espe, results='asis'}

CMA_print_in_line(db.sp$sp_habitos, 
                  'Hábitos:')

CMA_print_in_line(db.sp$sp_habitos_especializados, 
                  'Hábitos especializados:')

CMA_print_in_line(db.sp$sp_habitos_especializados_otro, 
                  "Otro hábito especializado: comentarios", 
                  '\n\n')

```

```{r cont.eto, results='asis'}
CMA_parse_eto_eco(db.sp)

CMA_print_in_line(db.sp$sp_tolerancia_a_hab_antropizados, 
                  'Tolerancia a hábitats antropizados:')


CMA_print_in_line(db.sp$sp_dieta, 'Dieta:')

CMA_print_in_line(db.sp$sp_dieta_especializada, 'Dieta especializada:')

CMA_print_in_line(db.sp$sp_aspectos_reproductivos, 
                  'Aspectos reproductivos', 
                  '\n\n')

CMA_print_in_line(db.sp$sp_patron_de_actividad, 'Patrón de actividad:')

CMA_print_in_line(db.sp$sp_gregariedad, 'Gregariedad:')

CMA_print_in_line(db.sp$sp_tamanio_de_grupo, 'Tamaño de grupo:')

CMA_print_in_line(db.sp$sp_tamanio_de_grupo_coment, 
                  '')

CMA_print_in_line(db.sp$sp_area_de_accion,'Área de acción', '\n\n')
```

```{r title.inves, results='asis'}
CMA_print_titles("CONSERVACIÓN E INVESTIGACIÓN") %>% cat()
```

\vspace{-0.4cm}

```{r cont.inves,results='asis'}
cat('**Amenazas por grado: de 1 (menor) a 5 (mayor)**\n\n')

CMA_parse_threats(db.sp) %>% cat

db.sp$sp_amenazas_comentarios %>% 
  CMA_italize_binomial(., db.sp$title) %>% 
  str_replace_all('\n', '\n\n') %>% cat

cat('\n\n')

CMA_print_in_line(db.sp$sp_en_area_nat_protegida, 
                  'La especie ¿está presente en áreas naturales protegidas?:')
```

```{r, results='asis'}
if(!is.na(db.sp$sp_en_area_nat_protegida_coment)){
  cat('**Presencia de la especie en áreas naturales protegidas** \n\n')
  
  db.sp$sp_en_area_nat_protegida_coment %>% 
    str_replace_all('\n', '\n\n') %>% 
    CMA_italize_binomial(., db.sp$title) %>% 
    str_trim(side = 'right') %>% cat
}
```

```{r, results='asis'}
if(!is.na(db.sp$sp_marco_legal)){
cat('**Marco legal de la especie**\n\n')
db.sp$sp_marco_legal %>%    
  str_replace_all('\n', '\n\n') %>% 
  CMA_italize_binomial(., db.sp$title) %>% cat}
```

```{r, results='asis'}
if(!is.na(db.sp$sp_planes_de_conservacion)){
  cat('**Planes de acción y/o proyectos de conservación o manejo actuales**\n\n')
  db.sp$sp_planes_de_conservacion %>%    
  str_replace_all('\n', '\n\n') %>% 
  CMA_italize_binomial(., db.sp$title) %>% cat
}

cat('\n\n')

CMA_print_in_line(db.sp$sp_reintroducciones, 
                  'Experiencias de reintroducción o erradicación:')
```

```{r, results='asis'}
if(db.sp$sp_reintroducciones != 'no'){
db.sp$sp_reintroducciones_comentarios %>%   
  str_replace_all('\n', '\n\n') %>% 
  CMA_italize_binomial(., db.sp$title) %>% cat
}

n <- db.sp$sp_valorizacion_socioeconomica %>% str_split(',', simplify = T) %>% str_trim()
if(!all(is.na(n))){
tibble(
  c("Valorización socioeconómica de la especie:", 
    rep("", length(n)-1)), '', n) %>% CMA_kable_output(cat = 'other') %>% cat
  }
cat('\n\n')

if(all(is.na(n))){
CMA_print_in_line(db.sp$sp_usos_y_valores %>% CMA_italize_binomial(db.sp$title) %>% 
                    str_replace_all('\n', '\n\n') %>% 
    str_trim(side = 'right'), 
                  'Valorización socioeconómica de la especie', '\n\n')
} else {
    db.sp$sp_usos_y_valores %>% CMA_italize_binomial(db.sp$title) %>% 
                      str_replace_all('\n', '\n\n') %>% 
    str_trim(side = 'right') %>% cat
}

```

```{r, results='asis'}
if(!is.na(db.sp$sp_rol_ecologico_y_ecoservicios)){
  cat('**Rol ecológico / servicios ecosistémicos**\n\n')
  db.sp$sp_rol_ecologico_y_ecoservicios %>%   
    str_replace_all('\n', '\n\n') %>% 
    CMA_italize_binomial(., db.sp$title) %>% cat
}
```

```{r, results='asis'}
cat('**Necesidades de investigación y conocimiento**\n\n')

db.sp$sp_necesidades_de_investigacion %>% 
  str_replace_all('\n', '\n\n') %>% 
  CMA_italize_binomial(., db.sp$title) %>% cat
```

\arrayrulecolor{white}

```{r title.biblio, results='asis'}
CMA_print_titles("BIBLIOGRAFÍA") %>% cat()
```

\vspace{-0.4cm}

```{r biblio.cont,  results='asis'}

cat('\\setlength{\\parindent}{20pt}')

cat('\\noindent\\textbf{LITERATURA CITADA}\n\n')

cit.bib <- db.sp$sp_bibliografia_citada %>% str_split('\n') %>% unlist() %>% 
  map_chr(., ~CMA_italize_binomial(.x, db.sp$title))

cat(paste(cit.bib, collapse = '\n\n'))
cat('\n\n')

if(!is.na(db.sp$sp_bibliografia_de_referencia)){
cat('\\noindent\\textbf{LITERATURA DE REFERENCIA}\n\n')

ref.bib <- db.sp$sp_bibliografia_de_referencia %>% str_split('\n') %>% unlist()%>% 
  map_chr(., ~CMA_italize_binomial(.x, db.sp$title))
cat(paste(ref.bib, collapse = '\n\n'))
cat('\n\n')
}
```

\setlength{\parindent}{0pt}

```{r title.autores, results='asis'}
CMA_print_titles("AUTORES Y COLABOLADORES") %>% cat()
```

\vspace{-0.4cm}

```{r cont.autores, echo=FALSE,include=TRUE, results='asis'}
CMA_parse_authors(db.sp) %>% 
  CMA_print_authors()
```

<!-- \begin{Center} -->
<!-- \begin{framed}[0.7\textwidth] -->
<!--   \begin{minipage}{\linewidth} -->
<!--     \Centering -->
<!--     \small -->
<!--   Este documento fue generado automáticamente\\ -->
<!--   Fecha de compilación: `r Sys.time()`\\ -->
<!--   La reproducción sin cambios de este documento está permitida\\ -->
<!--   Si encuentra errores por favor escribir a comisioncma@sarem.com\\ -->
<!--   \end{minipage} -->
<!-- \end{framed} -->
<!-- \end{Center} -->